<html>
  <head>
    <!-- Load Socket.IO from our web server, which is separate from the
  application's server. -->
    <script src="socket.io/socket.io.js"></script>
    <script>
      // Tell Socket.IO where to find the Flash component if the browser needs it.
      WEB_SOCKET_SWF_LOCATION = 'http://localhost/socket.io/WebSocketMain.swf';
    </script>

    <script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.6.0/underscore-min.js"></script>
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script src="moment.min.js"></script>

    <style>
      .axis path,
      .axis2 line,
      .axis2 path,
      .axis line {
        fill: none;
        stroke: #000;
        shape-rendering: crispEdges;
      }

      .line2 {
        stroke: steelblue;
        stroke-width: 1;
        fill: none;
        clip-path: url(#clip);
      }

      .area {
        /*fill: steelblue;*/
        clip-path: url(#clip);
      }

      .overlay {
        opacity: 0.3;
        fill: none;
        pointer-events: all;
        z-index: 25;
      }

      .tooltip .hover-line {
        fill: none;
        stroke: black;
        stroke-width: 1;
      }

      .brush .extent {
        stroke: #fff;
        fill-opacity: .125;
        shape-rendering: crispEdges;
      }
    </style>
  </head>
  <body>
    <h2>Console</h2>

    <!-- A log for messages -->
    <div id="messages" style="height:90px; border: 1px solid #000; width: 100%; color: #0F0; background: #000; font-family: monospace; overflow:scroll; overflow-x:hidden;">
      Connecting to server...<br/>
    </div>

    <h2>Nesse Core: Client Stub</h2>

    <label for="nameInput">Name:</label>
    <input type="text" id="nameInput" value="" />
    <button type="button" id="addObject">Add</button>

    <h2>Frontend</h2>

    <ul id="availableObjects" style="list-style-type:none;">
    </ul>

    <div id="timeline" style="margin-left:50px;"></div>

    <script>
      // Make the output visible
      var messages = document.getElementById('messages');

      // Connect to our app.js, which is listeninging on port 1080 
      var socket = io.connect('http://localhost:1080');
      
      // Console
      socket.on('connect', function() {
        messages.innerHTML += 'Connected<br/>';
      });
      socket.on('connectionStatus', function(data) {
        console.log("connectionStatus:" + data.toString());
        messages.innerHTML += 'Server says: "' + data.toString() + '"<br/>';
        
        $('#messages').animate({"scrollTop": $('#messages')[0].scrollHeight}, "fast");
      });

      // Add new objects to list
      socket.on('addedObject', function(data) {
        $("#availableObjects").append("<li>"+data.name+"</li>");
      });

      var first = null;

      // Add new objects to list
      /*socket.on('updatedObject', function(data) {

        // Push new value in dataset
        for(var i in first.datasets) {
          if(first.datasets[i].key == data.key) {

            // Update data
            first.datasets[i].values.push({ timestamp: data.timestamp, value: data.value});

            // Update focus
            xs[i].domain(d3.extent(first.datasets[i].values, function(d) { return parseDate(d.timestamp); }));
            ys[i].domain([0, d3.max(first.datasets[i].values, function(d) { return d.value; })]);

            // Update context
            x2.domain(d3.extent(first.datasets[i].values, function(d) { return parseDate(d.timestamp); }));

            // Update line and axis
            //svg.select(".area").attr("d", main_lines[i](first.datasets[i].values));
            svg.select(".area").attr("d", main_lines[i](first.datasets[i].values));
            //svg.select(".x.axis").call(xAxes[i]);
            svg.select(".y"+i+".axis").call(yAxes[i]);
            svg.select(".line2").attr("d", context_line(first.datasets[i].values));
            svg.select(".x.axis2").call(xAxis2);

            // Keep brushed
            brushed();
          }
        }     
      });*/

      // Get all objects and display them in a list
      $.get("http://localhost:1080/testcases", function( data ) {

        console.log(data);

        for(var i in data) {
          $("#availableObjects").append("<li>"+data[i].name+"</li>");
        }

        // TODO: Change this
        first = data[0];
        console.log(first);

        xAxes = new Array();
        yAxes = new Array();
        xs = new Array();
        ys = new Array();
        main_lines = new Array();

        for(var i in first.datasets) {
          first.datasets[i].values.splice(0, 0, { timestamp: "10 05 2014, 17:56:33", value: null});
        }

        console.log(first);

        createSVGContainer(first.datasets);
        for(var i in first.datasets) {
          if(first.datasets[i].type == "int") {
            createLineChart(first.datasets[i], i);
          }
        }

        // Give every area a different color
        color = d3.scale.category20();
        d3.selectAll(".area").attr("fill",function(d,i){return color(i);});

        // Tooltips
        /*bisectDate = d3.bisector(function(d) { return parseDate(d.timestamp); }).left

        d3.selectAll(".focus").append("rect")
          .datum(first.datasets)
          .attr("class", "overlay")
          .attr("width", width)
          .attr("height", height)
          .on("mouseover", function() { tooltip.style("display", null); })
          .on("mouseout", function() { tooltip.style("display", "none"); })
          .on("mousemove", mousemove);

        var tooltip = d3.selectAll(".focus").append("g")
            .attr("class", "tooltip")
            .style("display", "none");

        tooltip.append("g")
            .attr("class", "hover-line")
            .append("line")
            .attr("x1", 0).attr("x2", 0) 
            .attr("y1", 0).attr("y2", height);

        focus.append("text")
            .attr("class", "y1")
            .attr("x", 5)
            .attr("y", height/2)
            .attr("dy", ".35em");

        focus2.append("text")
            .attr("class", "y2")
            .attr("x", 5)
            .attr("y", height/2)
            .attr("dy", ".35em");

        function mousemove() {
          var x0 = x.invert(d3.mouse(this)[0]),
          i = bisectDate(first.datasets[0].values, x0, 1),
          d0 = first.datasets[0].values[i - 1],
          d1 = first.datasets[0].values[i],
          d = x0 - d0.timestamp > d1.timestamp - x0 ? d1 : d0;

          tooltip.attr("transform", "translate(" + x(parseDate(d.timestamp)) + "," + 0 + ")");
          focus.select("text.y1").attr("transform", "translate(" + x(parseDate(d.timestamp)) + "," + 0 + ")").text(d.value);

          var x0 = x.invert(d3.mouse(this)[0]),
          i = bisectDate(first.datasets[1].values, x0, 1),
          d0 = first.datasets[1].values[i - 1],
          d1 = first.datasets[1].values[i],
          d = x0 - d0.timestamp > d1.timestamp - x0 ? d1 : d0;
          tooltip.attr("transform", "translate(" + x(parseDate(d.timestamp)) + "," + 0 + ")");
          focus2.select("text.y2").attr("transform", "translate(" + x(parseDate(d.timestamp)) + "," + 0 + ")").text(d.value);
        }*/
      });

      function createLineChart(dataset, i) {

        // Focus lines
        main_line = d3.svg.area()
          .interpolate("linear")
          .x(function(d) { return xs[i](parseDate(d.timestamp)); })
          .y0(height)
          .y1(function(d) { return ys[i](d.value); });

        main_lines.push(main_line);

        focus = svg.append("g")
            .attr("class", "focus" + i)
            .attr("transform", "translate(" + margin.left + "," + margin.top * (i+1)*2 + ")"); // TODO: margintop * i

        focus.append("path")
            .datum(dataset.values)
            .attr("class", "area")
            .attr("d", main_line);

        focus.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + height + ")")
            .call(xAxes[i]);

        focus.append("g")
            //.attr("class", "y axis")
            .attr("class", "y"+i+ " axis")
            .call(yAxes[i]);
      }

      function createSVGContainer(datasets) {

        var context_dataset = null;
        for(var i in datasets) {
          if(datasets[i].type == "string") {
            context_dataset = datasets[i];
          }
        }

        margin = {top: 10, right: 10, bottom: 60, left: 40},
            margin2 = {top: 215, right: 10, bottom: 10, left: 40},
            width = 960 - margin.left - margin.right,
            height = 250 - margin.top - margin.bottom,
            height2 = 250 - margin2.top - margin2.bottom;

        parseDate = d3.time.format('%d %m %Y, %H:%M:%S').parse;

        for(var i in datasets) {
          drawAxis(datasets[i]);
        }

        x2 = d3.time.scale().range([0, width]), // Context
            y2 = d3.scale.linear().range([height2, 0]); // Context

        xAxis2 = d3.svg.axis().scale(x2).orient("bottom"), // Context
            yAxis2 = d3.svg.axis().scale(y).orient("left"); // Context

        // TODO: dont care about which domain is choosen. Later i will use the log scattersplott here.
        x2.domain(x.domain());
        y2.domain(y.domain());

        brush = d3.svg.brush()
            .x(x2)
            .on("brush", brushed);

        // Context line
        context_line = d3.svg.line()
            .interpolate("linear")
            .x(function(d) { return x2(parseDate(d.timestamp)); })
            .y(function(d) { return y2(d.value); });

        // Create container svg element
        svg = d3.select("#timeline").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", 3*height + margin.top + margin.bottom); // TODO: 3 to x

        // Clip on edges
        svg.append("defs").append("clipPath")
            .attr("id", "clip")
          .append("rect")
            .attr("width", width)
            .attr("height", height);

        context = svg.append("g")
            .attr("class", "context")
            .attr("transform", "translate(" + margin2.left + "," + margin2.top * 2 + ")");

        context.append("path")
            .datum(datasets[1])
            .attr("class", "line")
            .attr("d", context_line);

        context.append("g")
            .attr("class", "x axis2")
            .attr("transform", "translate(0," + height2 + ")")
            .call(xAxis2);

        context.append("g")
            .attr("class", "x brush")
            .call(brush)
          .selectAll("rect")
            .attr("y", -6)
            .attr("height", height2 + 7);
      }

      function drawAxis(dataset) {
        x = d3.time.scale().range([0, width]), // Focus
            y = d3.scale.linear().range([height, 0]); // Focus

        // Axis
        xAxis = d3.svg.axis().scale(x).orient("bottom"), // Focus
            yAxis = d3.svg.axis().scale(y).orient("left"); // Focus

        x.domain(d3.extent(first.datasets[0].values.map(function(d) { return parseDate(d.timestamp); })));
        //y.domain([0, 100]);
        //y.domain(d3.extent(dataset.values, function(d) { return d.value; }));
        y.domain([0, d3.max(dataset.values, function(d) { return d.value; })]);

        // Save domains and axes for later retrieval
        xAxes.push(xAxis);
        yAxes.push(yAxis);
        xs.push(x);
        ys.push(y);
      }

      function brushed() {
        for(var i in main_lines) {
          xs[i].domain(brush.empty() ? x2.domain() : brush.extent());
          d3.select(".focus"+i).select(".area").attr("d", main_lines[i]);
          d3.select(".focus"+i).select(".x.axis").call(xAxes[i]);
        }
      }

      //
      // Nessee Mock Stuff...
      //

      // Add new object button (from nessee mock)
      $("#addObject").click(function(){

        // Build mock object
        var data = JSON.stringify({ 
                      name: $("#nameInput").val(), 
                      datasets: [], 
                      origin_id: "xxxxxxxxxx-xxxx-xxxx" 
                    });

        $.ajax({
          url : "http://localhost:1080/testcases",
          type: "POST",
          contentType: 'application/json',
          data : data,
          success: function(data, textStatus, jqXHR) {
              console.log("post success");
              console.log(data);
              $("#nameInput").val("");
          },
          error: function (jqXHR, textStatus, errorThrown) {
            console.log("post error");
          }
        });
      });

      // Get all objects and update them periodically
      $.get("http://localhost:1080/testcases", function( testcases ) {
        for(var i in testcases) {
            updateEveryObjectsCPU(testcases[i]);
            updateEveryObjectsAgentNumber(testcases[i]);
            //updateLog(testcases[i]);
        }
      });

      function updateEveryObjectsCPU(testcase) {
        window.setInterval(function(){
          var id = testcase._id;
          var newCpuValue = _.random(1, 100);

          $.ajax({
            url : "http://localhost:1080/testcases/" + id,
            type: "PUT",
            contentType: 'application/json',
            data : JSON.stringify({ key: "cpuLoad", type: "int", value: newCpuValue, timestamp: moment().format('DD MM YYYY, HH:mm:ss')}),
            success: function(data, textStatus, jqXHR) {
                console.log("put success");
                console.log(data);
            },
            error: function (jqXHR, textStatus, errorThrown) {
              console.log("put error");
            }
          });
        }, 5000);
      }

      function updateEveryObjectsAgentNumber(testcase) {
        window.setInterval(function(){
          var id = testcase._id;
          var newAgentNumber = _.random(3, 10);

          $.ajax({
            url : "http://localhost:1080/testcases/" + id,
            type: "PUT",
            contentType: 'application/json',
            data : JSON.stringify({ key: "agentNumber", type: "int", value: newAgentNumber, timestamp: moment().format('DD MM YYYY, HH:mm:ss')}),
            success: function(data, textStatus, jqXHR) {
                console.log("put success");
                console.log(data);
            },
            error: function (jqXHR, textStatus, errorThrown) {
              console.log("put error");
            }
          });
        }, 3000);
      }

      function updateLog(testcase) {
        window.setInterval(function(){
          var id = testcase._id;
          var rndNumber = _.random(3, 100000);

          $.ajax({
            url : "http://localhost:1080/testcases/" + id,
            type: "PUT",
            contentType: 'application/json',
            data : JSON.stringify({ key: "log", type: "string", value: rndNumber, timestamp: moment().format('DD MM YYYY, HH:mm:ss')}),
            success: function(data, textStatus, jqXHR) {
                console.log("put success");
                console.log(data);
            },
            error: function (jqXHR, textStatus, errorThrown) {
              console.log("put error");
            }
          });
        }, 10000);
      }
    </script>

  </body>
</html>